<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>首页 · 小众点评</title>

  <!-- Bootstrap CSS + Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Piedra&family=Dancing+Script&display=swap" rel="stylesheet" />

  <!-- Your CSS -->
  <link rel="stylesheet" href="./css/style.css" />
  <link rel="stylesheet" href="./css/base.css" />
  <link rel="stylesheet" href="./css/components.css" />
  <link rel="stylesheet" href="./css/pages/home.css" />
</head>

<body>
  <!-- NAVBAR -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <a class="navbar-brand d-flex align-items-center" href="#">
        <i class="bi bi-shop me-2"></i> 小众点评
    </a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navMenu" aria-controls="navMenu" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>
    <div id="navMenu" class="collapse navbar-collapse">
        <ul class="navbar-nav ms-auto">
            <li class="nav-item">
                <a class="nav-link active" href="index.html">首页</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="search.html">附近商家</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="my_orders.html">我的订单</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="my_coupons.html">我的卡包</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="my_invitation.html">我的邀请</a>
            </li>
        </ul>
    </div>
  </nav>

  <!-- PAGE CONTENT -->
  <div class="page-content" id="content">
    <div class="container py-5 home-container">

      <h1 class="mb-3">欢迎，<span id="username"></span>！</h1>
      <p>登录时间：<span id="login-time"></span></p>

      <!-- 领取新人券 -->
      <a href="new_user_coupon.html" id="newUserCouponBtn" class="btn btn-warning btn-lg shadow-sm my-3">
        <i class="bi bi-ticket-perforated me-2"></i> 领取新人券
      </a>

      <!-- 快捷导航 -->
      <div class="row row-cols-1 row-cols-md-2 row-cols-lg-4 g-3 my-4">
        <div class="col">
          <a href="my_orders.html" class="btn btn-outline-primary w-100 py-3">
            <i class="bi bi-ticket-detailed me-2"></i> 查看订单
          </a>
        </div>
        <div class="col">
          <a href="my_coupons.html" class="btn btn-outline-secondary w-100 py-3">
            <i class="bi bi-box-seam me-2"></i> 我的卡包
          </a>
        </div>
        <div class="col">
          <a href="search.html" class="btn btn-outline-success w-100 py-3">
            <i class="bi bi-receipt-cutoff me-2"></i> 附近商家
          </a>
        </div>
        <div class="col">
          <a href="my_invitation.html" class="btn btn-outline-warning w-100 py-3">
            <i class="bi bi-people me-2"></i> 我的邀请
          </a>
        </div>
      </div>

      <button id="logout-btn" class="btn btn-outline-danger btn-sm">登出</button>

    </div>
  </div>

  <!-- Bootstrap JS (required for navbar toggler) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- 💡 Inline script to bypass backend auth while developing -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // 1️⃣  Display username / time
      fetch('/auth/status', {
        credentials: 'include'
      }).then(res => {
        if (!res.ok) {
          location.href = 'login.html';
          return Promise.reject('Not authenticated');
        }
        return res.json();
      }).then(data => {
        document.getElementById('username').textContent = data.username;
        document.getElementById('login-time').textContent = new Date().toLocaleString();
      }).catch(error => {
        console.error('Error fetching user status:', error);
        if (error !== 'Not authenticated') {
            location.href = 'login.html';
        }
      });

      document.querySelector('nav').addEventListener('click', e => {
        if (e.target.tagName === 'A') return;
        document.getElementById('sidebar')?.classList.toggle('active');
        document.getElementById('content')?.classList.toggle('active');
      });

      document.getElementById('logout-btn')
        ?.addEventListener('click', async () => {
          try {
            const res = await fetch('/auth/logout', {
              method: 'POST',
              credentials: 'include'
            });
            if (!res.ok) {
              const data = await res.json().catch(() => ({}));
              alert(data.detail || '登出失败。');
              return;
            }
            location.href = 'login.html';
          } catch (err) {
            alert('登出失败，请稍后再试。');
          }
        });
    });
  </script>
</body>
</html>
